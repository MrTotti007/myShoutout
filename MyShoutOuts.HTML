<!DOCTYPE html>
<html>
<head>
    <title>Streamer.bot Shout Out Player</title>
    <script>
        function showVideo() {
            const videoElement = document.getElementById('videoplayer');
            videoElement.style.visibility = "visible";
            videoElement.muted = false; // Unmute the video
            videoElement.play();
        }

        function shoutout() {
            // Parse URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const clipId = urlParams.get('clip_id');
            const image = urlParams.get('image');
            const time = urlParams.get('time');

            // Display the image
            document.getElementById('imagebox2').innerHTML = "<img src='" + image + "' width='100%'/>";
            console.log('Image URL:', image);

            // Use the clip ID to fetch the video source URL
            getVideoSourceFromAPI(clipId, function(videoSrc) {
                const videoElement = document.getElementById('videoplayer');
                videoElement.style.visibility = "hidden";
                videoElement.muted = true; // Mute the video initially
                videoElement.src = videoSrc;

                // Wait for the video to be ready before playing
                videoElement.addEventListener('canplay', function handler() {
                    videoElement.removeEventListener('canplay', handler);
                    showVideo();
                });

                // Add error handling
                videoElement.addEventListener('error', function() {
                    console.error('Video failed to load.');
                });

                videoElement.load();
            });
        }

        // Function to get video source URL from Twitch API
        function getVideoSourceFromAPI(clipId, callback) {
            if (!clipId) {
                console.error("Clip ID not found.");
                return;
            }

            console.log('Clip ID:', clipId);

            const url = "https://gql.twitch.tv/gql";
            const query = {
                operationName: "VideoAccessToken_Clip",
                variables: {
                    slug: clipId
                },
                extensions: {
                    persistedQuery: {
                        version: 1,
                        sha256Hash: "36b89d2507fce29e5ca551df756d27c1cfe079e2609642b4390aa4c35796eb11"
                    }
                }
            };

            var xhr = new XMLHttpRequest();
            xhr.open("POST", url, true); // Use asynchronous request
            xhr.setRequestHeader("Content-Type", "text/plain;charset=UTF-8");
            xhr.setRequestHeader("Client-ID", "kimne78kx3ncx6brgo4mv6wki5h1ko");

            xhr.onreadystatechange = function() {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        const clipInfo = JSON.parse(xhr.responseText);
                        const clipData = clipInfo.data;
                        const clipSource = clipData.clip.videoQualities[0].sourceURL;
                        const clipSig = clipData.clip.playbackAccessToken.signature;
                        const clipToken = clipData.clip.playbackAccessToken.value;
                        const videoSrc = clipSource + "?sig=" + clipSig + "&token=" + encodeURIComponent(clipToken);
                        console.log('Video Source URL:', videoSrc);
                        callback(videoSrc);
                    } else {
                        console.error("Request failed with status: " + xhr.status);
                    }
                }
            };
            xhr.send(JSON.stringify(query));
        }

        function cleanup() {
            document.getElementById('videocontainer').innerHTML = "";
            document.getElementById('imagebox2').innerHTML = "";
        }
    </script>
</head>
<body onload="shoutout();">
    <div id="videocontainer" style="position:absolute; left:0px; top:0px; width:100%; z-index:10; text-align:center;">
        <video id="videoplayer" style="width:100%;" preload="auto" onended="setTimeout('cleanup()', 500);"></video>
    </div>
    <div id="imagebox2" style="position:absolute; height:66%; width:37.5%; text-align:center; z-index:1; left:50%; top:50%; transform:translate(-50%, -50%);">
    </div>
</body>
</html>
